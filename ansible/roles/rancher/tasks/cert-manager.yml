---
- name: Probe cert-manager Namespace
  command: kubectl get ns cert-manager
  changed_when: false
  ignore_errors: true
  register: certmanager_ns

- name: Create cert-manager Namespace
  command: kubectl create namespace cert-manager
  when: certmanager_ns is failed

- name: Probe cert-manager Namespace Label
  command: kubectl get namespace --selector certmanager.k8s.io/disable-validation=true
  changed_when: false
  register: certmanager_ns_label

- name: Disable Resource Validation on cert-manager Namespace
  command: kubectl label namespace cert-manager certmanager.k8s.io/disable-validation=true
  when: "'No resources found' in certmanager_ns_label.stderr"

- name: Add Jetstack Repo for cert-manager
  command: helm repo add jetstack https://charts.jetstack.io
  when: not (repos.stdout | from_json | json_query("[?name==`jetstack`]"))

- name: Migrate chart to Helm 3
  command: helm 2to3 convert --ignore-already-migrated cert-manager

- name: Install cert-manager
  command: >
    helm upgrade cert-manager jetstack/cert-manager
      --namespace cert-manager
      --version {{ cert_manager_version }}
      --set installCRDs=true
      --wait --install
  when: not (charts.stdout | from_json | json_query("[?name==`cert-manager`]"))
