---
- name: Add Rancher Repo
  command: helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
  when: not (repos.stdout | from_json | json_query("[?name==`rancher-stable`]"))

- name: Migrate chart to Helm 3
  command: helm 2to3 convert --ignore-already-migrated rancher

- name: Register ingress API version
  command: kubectl get ingress -n cattle-system rancher -ojsonpath='{.apiVersion}'
  register: rancher_ingress_api_version

- name: Delete Rancher ingress (2to3 workaround)
  command: kubectl delete ingress -n cattle-system rancher
  when: rancher_ingress_api_version == "extensions/v1beta"

- name: Install Rancher
  command: >
    helm upgrade rancher rancher-stable/rancher
      --namespace cattle-system
      --version {{ rancher_version }}
      --set replicas={{ node_count }}
      --set antiAffinity=required
      --set tls=external
      --set privateCA=true
      --set restrictedAdmin=true
      --set auditLog.level=1
      --set bootstrapPassword={{ rancher_password }}
      --description='RanchHand Deploy'
      --set rancherImageTag={{ rancher_image_tag }}
      --wait --install

- name: Wait for Rancher to be available
  command: kubectl rollout status --watch deployment rancher --namespace=cattle-system

- name: Check if Rancher is Accessible
  uri:
    url: https://localhost/ping
    method: GET
    validate_certs: no
  register: result
  until: result.status == 200
  retries: 10
  delay: 3
