---
- name: install apt packages
  become: true
  apt:
    name:
      - unzip
      - tar

- name: Download Binary Tools
  get_url:
    url: "{{ item }}"
    dest: "{{ tools_dir }}"
    mode: a+x
  with_items:
    - https://storage.googleapis.com/kubernetes-release/release/v1.15.2/bin/linux/amd64/kubectl
    - https://github.com/rancher/rke/releases/download/v0.2.7/rke_linux-amd64

- name: Download Packaged Binary Tools
  unarchive:
    src: "{{ item }}"
    dest: "{{ tools_dir }}"
    remote_src: yes
    extra_opts: [--strip-components=1]
  with_items:
    - https://storage.googleapis.com/kubernetes-helm/helm-v2.14.3-linux-amd64.tar.gz
    - https://github.com/rancher/cli/releases/download/v2.2.0/rancher-linux-amd64-v2.2.0.tar.gz

- name: Set packaged binary tools as executable
  file: dest="{{ tools_dir }}/helm" mode=a+x

- name: Create executable symbolic links
  become: true
  file:
    src: "{{ tools_dir }}/{{ item.src }}"
    dest: "/bin/{{ item.dest }}"
    state: link
    mode: a+rx,u+rwx
  with_items:
    - {src: rke_linux-amd64, dest: rke}
    - {src: rancher-v2.2.0/rancher, dest: rancher}
    - {src: helm, dest: helm}
    - {src: kubectl, dest: kubectl}

# K8s Installation
- name: Create K8s Configuration Directory
  become: true
  file: path=/etc/kubernetes state=directory

- name: Copy k8s Configurations
  become: true
  copy: src="{{ item }}" dest="/etc/kubernetes/{{ item }}" mode=600 owner=root
  with_items:
    - admission.yaml
    - audit.yaml
    - event.yaml

- name: Create Self Signed OpenSSL Certificate Directory
  become: true
  file: path="{{ item }}" state=directory
  with_items:
    - /etc/ssl/crt
    - /etc/ssl/private
    - /etc/ssl/csr

- name: Install Crypto Pkgs
  become: true
  apt:
    name:
      - python3-pip
      - libssl-dev

- name: Install Python Crypto Module
  become: true
  pip: name=pyOpenSSL

- name: Generate an OpenSSL Private Key (one host only)
  become: true
  openssl_privatekey:
    path: /etc/ssl/private/dominodatalab.com.pem
    mode: u+rw
    owner: "{{ ansible_user_id }}"
  run_once: true

- name: Generate an OpenSSL Certificate Signing Request (one host only)
  become: true
  openssl_csr:
    path: /etc/ssl/csr/dominodatalab.com.csr
    privatekey_path: /etc/ssl/private/dominodatalab.com.pem
    common_name: www.ansible.com
  run_once: true

- name: Generate a Self Signed OpenSSL Certificate (one host only)
  become: true
  openssl_certificate:
    path: /etc/ssl/crt/dominodatalab.com.crt
    privatekey_path: /etc/ssl/private/dominodatalab.com.pem
    csr_path: /etc/ssl/csr/dominodatalab.com.csr
    provider: selfsigned
  run_once: true

- name: Download Generated Self Signed OpenSSL Certificate (one host only)
  become: true
  fetch:
    src: "{{ item.remote }}"
    dest: "{{ item.local }}"
    flat: yes
  with_items:
    - {remote: /etc/ssl/crt/dominodatalab.com.crt, local: /tmp/dominodatalab.com.crt}
    - {remote: /etc/ssl/private/dominodatalab.com.pem, local: /tmp/dominodatalab.com.pem}
  run_once: true

- name: Copy Self Signed OpenSSL Certificate
  become: true
  copy: src="{{ item.local }}" dest="{{ item.remote }}" mode=u+rw owner="{{ ansible_user_id }}"
  with_items:
    - {remote: /etc/ssl/crt/dominodatalab.com.crt, local: /tmp/dominodatalab.com.crt}
    - {remote: /etc/ssl/private/dominodatalab.com.pem, local: /tmp/dominodatalab.com.pem}

- name: Copy RKE Template
  template:
    src: rancher-cluster.yml
    dest: rancher-cluster.yml

- name: Save K8s State (on upgrade only)
  command: "rke etcd snapshot-save --name snapshot-{{ ansible_date_time.iso8601_basic }} --config ./rancher-cluster.yml"
  when: false # TODO: create proper coniditional

- name: Generate Rancher SSH Keypair
  openssh_keypair:
    path: /home/{{ ansible_user_id }}/.ssh/rancher
  run_once: true

- name: Download Rancher SSH Keypair
  fetch:
      src: "{{ item.remote }}"
      dest: "{{ item.local }}"
      flat: yes
  with_items:
    - {remote: "/home/{{ ansible_user_id }}/.ssh/rancher", local: /tmp/rancher}
    - {remote: "/home/{{ ansible_user_id }}/.ssh/rancher.pub", local: /tmp/rancher.pub}
  run_once: yes

- name: Distribute SSH Keypair
  copy:
    src: "{{ item.local }}"
    dest: "{{ item.remote }}"
  with_items:
    - {remote: "/home/{{ ansible_user_id }}/.ssh/rancher", local: /tmp/rancher}
    - {remote: "/home/{{ ansible_user_id }}/.ssh/rancher.pub", local: /tmp/rancher.pub}

- name: Set Rancher Authorized Key
  authorized_key:
    user: "{{ ansible_user_id }}"
    state: present
    key: "{{ lookup('file', '/tmp/rancher.pub') }}"

- name: Run rke Install/Upgrade (one host only)
  command: rke up --config ./rancher-cluster.yml creates=rancher-cluster.rkestate
  run_once: true

- name: Create kubectl Directory
  file: path="/home/{{ ansible_user_id }}/.kube" state=directory
  run_once: true

- name: Copy kubectl Configuration
  copy:
    src: "/home/{{ ansible_user_id }}/kube_config_rancher-cluster.yml"
    dest: "/home/{{ ansible_user_id }}/.kube/config"
    remote_src: true
  run_once: true


